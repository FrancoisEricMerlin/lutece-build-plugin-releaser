<div class="app-wrapper">
<!-- TO REMOVE WHEN feature_frameset.html will be correctly added to this template -->
<section class="content-header">
    <h1>
        <a href="jsp/admin/plugins/releaser/ManageClusters.jsp" title="#i18n{releaser.adminFeature.ManageReleaser.name}">#i18n{releaser.adminFeature.ManageReleaser.name}</a>
        <small class="hidden-xs hidden-sm">Pr&eacute;paration de la release du <#if !site.theme>Site<#else>Theme</#if></small>
    </h1>
    <ol class="breadcrumb applications">
    </ol>
</section>
<section class="content ">
<!-- EN TO REMOVE -->
<div class="row">
  <div class="col-xs-12 col-sm-12">
    <div class="info-box info-box-release">
      <span class="info-box-icon bg-aqua"><i class="fa fa-cube"></i></span>
      <div class="info-box-content">
        <div class="col-xs-7 col-sm-7">
          <span class="info-box-text">
            ${site.name} [${site.artifactId !''}-${site.version!''}]
            - <i class="fa fa-cubes text-green"></i>  Cluster <strong>${site.cluster !''}</strong>
            - <i class="fa fa-puzzle-piece text-yellow"></i> Nombre de plugins <strong>${site.components?size}</strong>
          </span>
          <span class="info-box-number">${site.description}</span>
        </div>
        <div class="col-xs-5 col-sm-5">
           <a class="btn btn-info btn-lg btn-release-history" title="Visuliser l'historique des releases" href="jsp/admin/plugins/releaser/ManageSiteRelease.jsp?view=releaseComponentHistory&artifact_id=${site.artifactId !''}" target="_blank">
                  <i class="fa fa-cog fa-fw"></i> Visualiser l'historique des releases du <#if !site.theme>Site<#else>Theme</#if>
            </a>
          <button type="button" class="btn btn-success btn-lg" data-toggle="modal" data-target="#modalRelease">
            <span class="fa fa-cogs"></span>  Releaser le <#if !site.theme>Site<#else>Theme</#if>
          </button>
        </div>
        
        </div>
        <div class="pull-right hidden">
          <@aButton href='jsp/admin/plugins/releaser/ManageClusters.jsp#cluster${site.idCluster}' title='Retour au cluster' buttonIcon='cubes' showTitle=true />
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
      <div class="info-box info-box-release components">
        <span class="info-box-icon bg-yellow"><i class="fa fa-puzzle-piece"></i></span>
        <div class="info-box-content">
          <span class="info-box-text">Liste des composants</span>
          <span class="info-box-number">Composants projet</span>
        </div>
      </div>
      <ul class="list-group list-components fa-padding">
      <#list site.components as component>
        <#if component.project>
          <li class="list-group-item">
            <div class="media">
              <div class="media-left">
              </div>
              <div class="media-body">
              <p>
                <span class="artifact up">
                  ${component.artifactId!}
                  <a class="text-danger" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=projectComponent&artifact_id=${component.artifactId}' title='Supprimer des composants projet'>
                    <i class="fa fa-remove"></i>
                  </a>
                </span>
                <span id="release-result-${component.artifactId!}">
                <#if component.releaseComment! !=''><i class="fa fa-info-circle text-info"></i> ${component.releaseComment!''}</#if>
                <#if component.shouldBeReleased()>
                  <a class="button transition border-orange small btn-release" data-artifactid="${component.artifactId!}" title="Modifier la version pour la release" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=versionComponent&artifact_id=${component.artifactId}' >
                    <i class="fa fa-cog fa-fw"></i> Releaser le composant
                  </a>
                    <#if component.lastAvailableVersion?? >
                      <a class="button transition border-blue small" data-artifactid="${component.artifactId!}" title="Utiliser la version ${component.lastAvailableVersion} pour la release" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=downgradeComponent&artifact_id=${component.artifactId}' >
                        <i class="fa fa-cog fa-fw"></i> Utiliser la version ${component.lastAvailableVersion} pour la release
                      </a>
                    </#if>
                </#if>
                <#if component.downgrade>
                    <#if component.lastAvailableVersion?? >
                      <a class="button transition border-red small" data-artifactid="${component.artifactId!}" title="Utiliser la version ${component.lastAvailableVersion} pour la release" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=cancelDowngradeComponent&artifact_id=${component.artifactId}' >
                        <i class="fa fa-cog fa-fw"></i> Ne plus utiliser  la version ${component.lastAvailableVersion} pour la release
                      </a>
                    </#if>
                </#if>
                
               </span>
                <a id="histo-${component.artifactId!}" class="button transition border-blue small btn-release-history"  title="Visuliser l'historique des releases" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?view=releaseComponentHistory&artifact_id=${component.artifactId}' target="_blank">
                  <i class="fa fa-cog fa-fw"></i> Visualiser l'historique des releases
                </a>
                  <span class="number pull-right">
                    JIRA
                    <a href="${component.jiraRoadmapUrl!}">
                      <span class="label label-success">${component.jiraCurrentVersionClosedIssues}</span>
                      <#if component.jiraCurrentVersionOpenedIssues = 0 >
                        <span class="label label-success">${component.jiraCurrentVersionOpenedIssues}</span>
                      <#else>
                        <span class="label label-danger">${component.jiraCurrentVersionOpenedIssues}</span>
                      </#if>
                    </a>
                  </span>
                </p>
                <div id="progress-wrapper-${component.artifactId!}" class="progress-wrapper clearfix">
                  <div class="progress active pull-left ">
                    <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                      <span class="sr-only">0% Complete</span>
                    </div>
                  </div>
                  <div class="pull-left">
                    <button href="#" data-toggle="modal"   data-artifactid="${component.artifactId!}" id="view_log_btn_${component.artifactId!}"  data-target="#modalLogs" data-context_release_id="" class="view_log_btn button transition small fill-whitish-black">
                      Voir les logs
                    </button>
                  </div>
                </div>
                
                
                    <div class="row">
                      <div class="col-xs-12 col-sm-4">
                        Version actuelle <strong class="button transition fill-lightblue small">${component.currentVersion}</strong>
                         <i class="fa fa-arrow-right"></i> Version cible<strong class="button transition fill-lightblue small"> ${component.targetVersion}</strong>
                      </div>
                      <div class="col-xs-12 col-sm-7">
                       <i class="fa fa-arrow-right"></i>  Prochaine version
                        <span class="button transition fill-lightblue small">
                            <#if component.isSnapshotVersion()>
                               ${component.nextSnapshotVersion}
                            <#else>
                                ${component.targetVersion}
                            </#if>
                        </span>
                         <#if component.shouldBeReleased()>
                            <a class="button transition border-lightblue small" title="Modifier la version pour la release" id="btn-upgrade-version-${component.artifactId}" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=versionComponent&artifact_id=${component.artifactId}'>
                                 <i class="fa fa-level-up fa-fw"></i> Modifier la version pour la release
                            </a>
                          <#else>
                               <#if component.lastAvailableVersion?? && component.lastAvailableVersion != component.targetVersion >
                                      <a class="button transition border-lightblue small" title="Modifier la version pour la release" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=upgradeComponent&artifact_id=${component.artifactId}' >
                                          <i class="fa fa-level-up"></i> Upgrader le composant
                                      </a>
                                </#if>
                            
                         </#if> 
                      </div>
                    </div>
                 </div>
            </li>
          </#if>
        </#list>
      </ul>
      <div class="info-box info-box-release components">
        <span class="info-box-icon bg-yellow"><i class="fa fa-puzzle-piece"></i></span>
          <div class="info-box-content">
            <span class="info-box-text">Liste des composants</span>
            <span class="info-box-number">Composants externes</span>
          </div>
        </div>
        <ul class="list-group list-components">
          <#list site.components as component>
            <#if ! component.project>
              <li class="list-group-item" data-toggle="modal" data-target="#issue">
                <div class="media">
                  <div class="media-left">
                  </div>
                  <div class="media-body">
                    <p>
                      <span class="artifact up">
                        ${component.artifactId!}
                        <a class="text-success" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=projectComponent&artifact_id=${component.artifactId}' title='Ajouter des composants projet'>
                          <i class="fa fa-check fa-fw"></i>
                        </a>
                        <#if component.downgrade>
                            <#if component.lastAvailableVersion?? && component.isSnapshotVersion() >
                              <a class="button transition border-red small" data-artifactid="${component.artifactId!}" title="Utiliser la version ${component.lastAvailableVersion} pour la release" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=cancelDowngradeComponent&artifact_id=${component.artifactId}' >
                                <i class="fa fa-cog fa-fw"></i> Ne plus utiliser  la version stable ${component.lastAvailableVersion} 
                              </a>
                            </#if>
                         </#if>
                         <#if component.lastAvailableVersion?? && component.isSnapshotVersion() && !component.downgrade>
                              <a class="button transition border-blue small" data-artifactid="${component.artifactId!}" title="Utiliser la version ${component.lastAvailableVersion} pour la release" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=downgradeComponent&artifact_id=${component.artifactId}' >
                                <i class="fa fa-cog fa-fw"></i> Utiliser la version ${component.lastAvailableVersion} 
                              </a>
                           </#if>
                      </span>
                      <span class="number pull-right">
                        JIRA
                        <a href="${component.jiraRoadmapUrl!}">
                          <span class="label label-success">${component.jiraCurrentVersionClosedIssues}</span>
                          <#if component.jiraCurrentVersionOpenedIssues = 0 >
                            <span class="label label-success">${component.jiraCurrentVersionOpenedIssues}</span>
                          <#else>
                            <span class="label label-danger">${component.jiraCurrentVersionOpenedIssues}</span>
                          </#if>
                         </a>
                      </span>
                    </p>
                    <p>
                      <#if component.releaseComment! !=''>
                        <i class="fa fa-info-circle text-info"></i> ${component.releaseComment!''}
                      </#if>
                    </p>
                   <p class="info">
                    Version actuelle <strong class="button transition fill-lightblue small">${component.currentVersion}</strong>
                    <i class="fa fa-arrow-right"></i> Version cible
                    <#if component.currentVersion != component.targetVersion>
                     <strong class="button transition fill-lightblue small">${component.targetVersion}</strong>
                    <#else>
                      <strong>${component.targetVersion}</strong>
                    </#if>
                    <i class="fa fa-arrow-right"></i>  Prochaine version
                        <span class="button transition fill-lightblue small">
                             ${component.targetVersion}
                        </span>
                    <#if !component.isSnapshotVersion()&& component.lastAvailableVersion?? && component.lastAvailableVersion != component.targetVersion >
                      <a class="button transition border-lightblue small" title="Modifier la version pour la release" href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=upgradeComponent&artifact_id=${component.artifactId}' >
                        <i class="fa fa-level-up"></i> Upgrader le composant
                      </a>
                    </#if>
                   </p>
                  </div>
                </div>
               </li>
              </#if>
            </#list>
          </ul>
        </div>
       </div>
      </section>
    </div>
  </div>
<!-- Modal -->
<div class="modal fade" id="modalRelease" tabindex="-1" role="dialog" aria-labelledby="modalReleaseLabel">
  <div class="modal-dialog" role="document">
    <@tform name='release_site' class='form' action='jsp/admin/plugins/releaser/ManageSiteRelease.jsp'>
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="modalReleaseLabel">Release - Informations de version du <#if !site.theme>Site<#else>Theme</#if> </h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <p class="form-control-static">
              Derni&egrave;re version releas&eacute;e : <strong>${site.lastReleaseVersion!'n/a'}</strong>
            </p>
          </div>
          <div class="form-group">
            <p class="form-control-static">
              Version courante du site : <strong>${site.version!}</strong>
            </p>
          </div>
          <div class="form-group">
            <p class="form-control-static">
              Version de la release : <strong>${site.nextReleaseVersion!}</strong>
            </p>
          </div>
          <div class="form-group">
            <p class="form-control-static">
              Version de la prochaine de travail : <strong>${site.nextSnapshotVersion!}</strong>
            </p>
          </div>
          <div class="form-group">
            <label for="tag_information">#i18n{releaser.prepare_site_release.labelTagInformation}</label>
            <input type="text" name="tag_information" id="tag_information" value="${site.tagInformation!}" class="form-control">
          </div>
          <div class="form-group">
            <@aButton href='jsp/admin/plugins/releaser/ManageSiteRelease.jsp?action=versionSite' title='Modifier la version &agrave; releaser' buttonIcon='level-up' color='button transition border-lightblue small' showTitle=true />
          </div>
        </div>
        <div class="modal-footer">
           <button type="submit" class="button transition small fill-blue" name="action_releaseSite">Ok</button>
           <button type="button" class="button transition small fill-whitish-black" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </@tform>
  </div>
</div>
<div class="modal fade" id="modalLogs" tabindex="-1" role="dialog" aria-labelledby="modalLogsLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modalLogsLabel">Release - Logs</h4>
      </div>
      <div class="modal-body">
        <pre id="console_wf_log"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="button transition small fill-whitish-black" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
<script src="js/plugins/releaser/notify.min.js" type="text/javascript"></script>
<script src="js/plugins/releaser/releaser.js" type="text/javascript"></script>
<script>
var artifactIdInProgress;
    $(function() {
        $(".progress-wrapper").toggle();
        $(".view_log_btn").click( function(e){
            $("#console_wf_log").html(" ");
            var artifactId=$(this).attr("data-artifactid");
            var contextId=$(this).attr("context_release_id");
            artifactIdInProgress=artifactId;
            var progressId="#progress-wrapper-" + artifactId;
            callReleaseInfo( contextId,progressId,artifactId)
           }
        );
        $(".btn-release").click( function(e){
             $("#console_wf_log").html(" ");
             var artifactId=$(this).attr("data-artifactid");
             
             $("#btn-upgrade-version-"+artifactId).hide();
          var progressId="#progress-wrapper-" + artifactId;
        $( progressId ).toggle();
             $.ajax({
                    url: "jsp/admin/plugins/releaser/ReleaseComponentSiteJson.jsp?action=releaseComponent&artifact_id="+$(this).attr("data-artifactid"),
                    type: "GET",
                    dataType : "json",
                    success: function( data ) {
                     if (data.status == 'OK') {
                       callReleaseInfo(data.result,progressId,artifactId);
                       $( "#view_log_btn_"+artifactId).attr("data-context_release_id",data.result);
                      }
                     else if ( data.status == 'ERROR'  )
                     {
                    }
                   }
            });
            e.preventDefault();
    });
});
</script>
<#if open_site_version?? && open_site_version=="1" >
    <script>
        $(function() {
        
            $('#modalRelease').modal();
         
        });
    </script>
</#if>